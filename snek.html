<!doctype html>
<html>
    <head>
        <title>Hello, snake?</title>
        <style type="text/css">
            html, body { border: 0; margin: 0; padding: 2px; }
        </style>
    </head>
    <body>
        <canvas
          id="thingie"
          width="800"
          height="600"
          style="border: 7px inset black;">
            If you can see this, something has gone kablooie.
        </canvas>
        <p id="perf"></p>
    </body>
<script type="text/javascript">
"use strict";

// https://developer.mozilla.org/en-US/docs/Web/API/Canvas_API

const canvas = document.getElementById('thingie');
/** @type CanvasRenderingContext2D */
const ctx = canvas.getContext('2d');

function lolrand(max) {
    return Math.floor(Math.random() * max);
}

const canvas_width = 800;
const canvas_height = 600;
const grid = [];

const grid_size = 20;
const grid_x = Math.floor(canvas_width / grid_size);
const grid_y = Math.floor(canvas_height / grid_size);

const head_coords = [0, 0];
const food_coords = [1, 1];

let start_time = 0;
let last_time = 0;
let call_count = 0;
function draw(timestamp) {

    if (start_time == 0) {
        start_time = timestamp;
    }
    call_count++;

    if ( Math.floor(timestamp / 1000) > Math.floor(last_time / 1000) ) {
        document.getElementById('perf').textContent = call_count / (timestamp / 1000);
    }
    last_time = timestamp;

    for (let y = 0; y < grid_y; y++) {
        for (let x = 0; x < grid_x; x++) {
            if(grid[y][x] == 0) {
                ctx.fillStyle = '#abcdef';
                ctx.fillRect((x * grid_size) + 1, (y * grid_size) + 1, grid_size - 2, grid_size - 2);
            }
            if(grid[y][x] == 1) {
                ctx.fillStyle = '#807060';
                ctx.fillRect((x * grid_size) + 1, (y * grid_size) + 1, grid_size - 2, grid_size - 2);
            }
            if(grid[y][x] == 2) {
                ctx.fillStyle = '#903060';
                ctx.fillRect((x * grid_size) + 1, (y * grid_size) + 1, grid_size - 2, grid_size - 2);
            }
        }
    }

    window.requestAnimationFrame(draw);
}

function init_grid() {

    let empty_x_list = [];
    for (let x = 0; x < grid_x; x++) {
        empty_x_list.push(0);
    }
    for (let y = 0; y < grid_y; y++) {
        grid.push(empty_x_list.slice());
    }

    head_coords[0] = lolrand(grid_y);
    head_coords[1] = lolrand(grid_x);
    grid[ head_coords[0] ][ head_coords[1] ] = 1;

    food_coords[0] = lolrand(grid_y);
    food_coords[1] = lolrand(grid_x);
    grid[ food_coords[0] ][ food_coords[1] ] = 2;

    for (let x = 0; x <= grid_x; x++) {
        ctx.beginPath();
        ctx.moveTo(x * grid_size, 0);
        ctx.lineTo(x * grid_size, canvas_width);
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#aaaaaa';
        ctx.stroke();
        ctx.closePath();
    }

    for (let y = 0; y <= grid_y; y++) {
        ctx.beginPath();
        ctx.moveTo(0, y * grid_size);
        ctx.lineTo(canvas_width, y * grid_size);
        ctx.lineWidth = 2;
        ctx.strokeStyle = '#aaaaaa';
        ctx.stroke();
        ctx.closePath();
    }
}

function move_head(x, y) {
    grid[ head_coords[0] ][ head_coords[1] ] = 0;

    head_coords[0] += y;
    if (head_coords[0] >= grid_y) {
        head_coords[0] = 0;
    }
    if (head_coords[0] < 0) {
        head_coords[0] = grid_y - 1;
    }

    head_coords[1] += x;
    if (head_coords[1] >= grid_x) {
        head_coords[1] = 0;
    }
    if (head_coords[1] < 0) {
        head_coords[1] = grid_x - 1;
    }

    grid[ head_coords[0] ][ head_coords[1] ] = 1;
}

window.addEventListener('keydown', function (event) {
    if (event.key == 'ArrowDown') {
        move_head(0, 1);
    } else if (event.key == 'ArrowUp') {
        move_head(0, -1);
    } else if (event.key == 'ArrowLeft') {
        move_head(-1, 0);
    } else if (event.key == 'ArrowRight') {
        move_head(1, 0);
    }
});

init_grid();
window.requestAnimationFrame(draw);

</script>
</html>
